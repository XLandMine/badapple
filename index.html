<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style>
		*{
			margin: 0;
			padding: 0;	
		}
		body {
			background-color: #ccc;
		}
		.w{
			width: 400px;
			margin:  30px auto;
		}
		textarea {
			width:400px;
			display: block;
			height: 448px;
            outline-style: none;
            resize: none;
            overflow: hidden;
            margin: 0 auto;
            border: none;
		}
		.mtk {
			width: 100%;
			height: 100%;
			position: fixed;
			top: 0px;
			background-color: #fff;
		}
		.mtk button {
			position: absolute;
			top: 50%;
			left: 50%;
			margin-left: -75px;
			margin-top: -50px;
			width: 150px;
			height: 100px;
			font-size: 30px;
			line-height: 100px;
			text-align: center;
			opacity: 0;
			cursor: pointer;
			border-radius: 20%;
		}
		.mtk button:hover {
			background-color: #ff6700;
		}
		.mtk span {
			font: 25px "微软雅黑";
			position: absolute;
			display: block;
			top: 50px;
			left: 100px;
			color:#999;
		}
	</style>
	<script src="jquery-1.11.1.min.js"></script>
</head>
<body>
	<div id="mtk" class="mtk">
		<span>申请资源中....</span>
		<button id="btn">启动</button>
	</div>
	<div class="w">
		<textarea readonly="readonly" id="txt"></textarea><br>
	</div>      
	<!-- <video src="video/a.mp4" controls="controls" autoplay="autoplay"></video> -->
<script>
	var arr = [];
	var tm = null;
	var i = 0;        //将要播放的帧数
	var fps = null;   //一帧的播放速度
	var current = null;
	var previous = null;
	var mtk = $("#mtk");

	//页面加载完就获取资源
	$(function(){
		var xhr = new XMLHttpRequest();
		var baTxtStr = null;
		xhr.i = 0;//绑定index标识
		xhr.onreadystatechange = function(){
			if(xhr.readyState == 4){
				if((xhr.status>=200&&xhr.status<300)||xhr.status == 304){
					
					//将获取到的内容保存在变量baTxtStr中
					baTxtStr += xhr.responseText;
					mtk.children()[0].innerHTML += "<br>资源加载完成"+xhr.i+"0%";
					
					if(xhr.i == 10){
						mtk.children()[0].innerHTML += "<br>资源全部加载成功<br>允许播放";
						//显示开始按钮
						mtk.children("button").animate({"opacity":"1"},1000);
						//将获取到的内容通过“,”切割成字符串
						arr = baTxtStr.split(",");
						//播放时间为220秒 用时间/长度得出一帧播放的时间
						fps = 220*1000/arr.length;

						//释放内存
						baTxtStr = null;
						return;
					}

					xhr.open("get","badappleTxt.txt?num="+xhr.i,true);
					xhr.i++;
					xhr.send(null);
				}else{
					mtk.children()[0].innerHTML += "<br>资源加载失败,失败码为:"+xhr.status;
				}
			}
		}
		mtk.children()[0].innerHTML += "<br>申请资源成功<br>资源加载中....";
		//发送url到后台获取数据，由于数据量大，所以进行分10段去获取
		//通过num标识要获取第几段数据
		xhr.open("get","badappleTxt.txt?num="+xhr.i,true);
		xhr.i++;
		xhr.send(null);
		

		$("#btn").click(function(){
			var clientHeight = window.innerHeight|| document.documentElement.clientHeight|| document.body.clientHeight|| 2000;
			mtk.animate({
				"top":-clientHeight
			})
			//初始化参数
			i = 0;
			current = new Date();
		    previous = new Date();
			start();
		});

	});

	//开始播放字符串
	function start(){
		if(i <= arr.length){
			current = new Date();

			//定义一个dt来记录一帧实际播放时间
			var dt = current - previous;
			previous = current;

			$("#txt").val(arr[i]);

			//fps为理想帧率  fps-dt得出与实际帧率的差值
			var time = fps;
			//如果dt比fps大说明需要加快下一帧的速度以达到平衡
			//如果dt比fps小说明这次是上一次加快的，不需要处理
			if(dt > fps){
				/*
					理想数据为dt == fps == 62
					但是就算增加差值还是难以达到效果 
					dt总是大于62  使得视频播放时间大于220秒导致不同步
					测试所得dt 大约在62 - 65 之间
					所以为了尽量使dt  == fps
					所以对下一帧播放时间time再次-2
				*/
				time = fps + (fps - dt) - 2;
			}
			// console.log("dt----"+dt);
			tm = setTimeout("start()",time);
		}else{
			setTimeout(function(){
				mtk.children()[0].innerHTML += "<br>播放完成";
				mtk.animate({"top":0});
			},1000)
		}

		i++;

	}
</script>
</body>
</html>